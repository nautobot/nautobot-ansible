---
language: python
services:
  - docker

os: linux
dist: focal

stages:
  - test
  - integration

env:
  global:
    - COLLECTION_NAMESPACE: "networktocode"
    - COLLECTION_NAME: "nautobot"
    - COLLECTION_VERSION: "3.0.0"
    - COMPOSE_PROJECT_NAME: "nautobot_ansible"

python:
  - 3.6
  - 3.7
  - 3.8
  - 3.9

install:
  - pip install -U pip
  - pip install invoke
  - invoke start
  - docker-compose --version

script:
  - invoke unit

jobs:
  fast_finish: true
  include:
    - name: "Python 3.6 - Nautobot 1.0.X - ansible-base 2.10.X"
      python: 3.6
      stage: integration
      env:
        - INVOKE_NAUTOBOT_ANSIBLE_PYTHON_VER=3.6
        - INVOKE_NAUTOBOT_ANSIBLE_NAUTOBOT_VER=1.0.3
      script:
        - cat development/dev.env
        - cat development/docker-compose.yml
        - docker ps
        - sleep 60
        - docker ps -f name=nautobot_ansible_nautobot -q | xargs -L 1 docker logs
        - invoke integration
    - name: "Python 3.7 - Nautobot 1.1.X - Latest Ansible Core"
      python: 3.7
      stage: integration
      env:
        - INVOKE_NAUTOBOT_ANSIBLE_PYTHON_VER=3.7
        - INVOKE_NAUTOBOT_ANSIBLE_NAUTOBOT_VER=1.1.1
      script:
        - poetry install ansible-core
        - docker ps -f name=nautobot_ansible_nautobot -q | xargs -L 1 docker logs
        - invoke integration
    # - name: "Python 3.8 - Nautobot 1.1.X - Latest Ansible Core"
    #   python: 3.8
    #   env:
    #     - INVOKE_NAUTOBOT_ANSIBLE_PYTHON_VER=3.8
    #     - INVOKE_NAUTOBOT_ANSIBLE_NAUTOBOT_VER=develop
    #   script:
    #     - poetry install ansible-core
    #     - invoke integration

deploy:
  provider: script
  cleanup: true
  script: ansible-galaxy collection publish $TRAVIS_BUILD_DIR/$COLLECTION_NAMESPACE-$COLLECTION_NAME-$COLLECTION_VERSION.tar.gz --api-key="$GALAXY_API_TOKEN"
  on:
    tags: true
