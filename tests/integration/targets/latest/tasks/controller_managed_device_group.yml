---
- debug:
    msg: "{{ nautobot_version }}"

- block:
  - name: "CONTROLLER GROUP 1: Create Group"
    networktocode.nautobot.controller_managed_device_group:
      url: "{{ nautobot_url }}"
      token: "{{ nautobot_token }}"
      name: Test Controller Group One
      controller: controller_one
      weight: 1000
      state: present
    register: test_one

  - name: "CONTROLLER 1: ASSERT - Create Group"
    assert:
      that:
        - test_one['changed']
        - test_one['controller_managed_device_group']['name'] == "Test Controller Group One"

  - name: "CONTROLLER GROUP 2: Create duplicate"
    networktocode.nautobot.controller_managed_device_group:
      url: "{{ nautobot_url }}"
      token: "{{ nautobot_token }}"
      name: Test Controller Group One
      controller: "{{ controller['key'] }}"
      weight: 1000
      state: present
    register: test_two
    vars:
        # yamllint disable-line rule:line-length
        controller: "{{ lookup('networktocode.nautobot.lookup', 'controllers', validate_certs=documentation_nautobot.validate_certs, num_retries=3, api_endpoint=nautobot_url, token=nautobot_token, api_filter='name=controller_one') }}"

  - name: "CONTROLLER 2: ASSERT - Create duplicate"
    assert:
      that:
        - not test_two['changed']
        - test_two['controller_managed_device_group']['name'] == "Test Controller Group One"
        - test_two['msg'] == "controller_managed_device_group Test Controller Group One already exists"

  - name: "CONTROLLER GROUP 3: Update"
    networktocode.nautobot.controller_managed_device_group:
      url: "{{ nautobot_url }}"
      token: "{{ nautobot_token }}"
      name: Test Controller Group One
      weight: 2000
      controller: controller_two
    register: test_three

  - name: "CONTROLLER GROUP 3: ASSERT - Update"
    assert:
      that:
        - test_three['changed']
        - test_three['controller_managed_device_group']['name'] == "Test Controller Group One"
        - test_three['controller_managed_device_group']['controller'] == "controller_two"
        - test_three['msg'] == "controller_managed_device_group Test Controller Group One updated"

  - name: "CONTROLLER GROUP 4: ASSERT - Delete"
    networktocode.nautobot.controller_managed_device_group:
      url: "{{ nautobot_url }}"
      token: "{{ nautobot_token }}"
      name: Test Controller Group One
      controller: controller_two
      state: absent
    register: test_four

  - name: "CONTROLLER 4: ASSERT - Delete"
    assert:
      that:
        - test_four is changed
        - test_four['diff']['before']['state'] == "present"
        - test_four['diff']['after']['state'] == "absent"
        - test_four['msg'] == "controller_managed_device_group Test Controller Group One deleted"

  - name: "CONTROLLER GROUP 5: ASSERT - Delete non existing"
    networktocode.nautobot.controller_managed_device_group:
      url: "{{ nautobot_url }}"
      token: "{{ nautobot_token }}"
      name: Test Controller Group Two
      controller: controller_two
      state: absent
    register: test_five

  - name: "CONTROLLER GROUP 5: ASSERT - Delete non existing"
    assert:
      that:
        - not test_five['changed']
        - test_five['controller_managed_device_group'] == None
        - test_five['msg'] == "controller_managed_device_group Test Controller Group Two already absent"

  when:
    # Controllers are only available on Nautobot 2.2+
    - "nautobot_version is version('2.2', '>=')"
