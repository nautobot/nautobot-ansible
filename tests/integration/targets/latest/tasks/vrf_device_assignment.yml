---
##
##
### PYNAUTOBOT_VRF_DEVICE_ASSIGNMENT
##
##
- set_fact:
    vrf_device_assignment_vrf: "{{ lookup('networktocode.nautobot.lookup', 'vrfs', api_endpoint=nautobot_url, token=nautobot_token, api_filter='name=\"Test VRF\"') }}"
    vrf_device_assignment_device: "{{ lookup('networktocode.nautobot.lookup', 'devices', api_endpoint=nautobot_url, token=nautobot_token, api_filter='name=test100') }}"
    vrf_device_assignment_virtual_machine: "{{ lookup('networktocode.nautobot.lookup', 'virtual-machines', api_endpoint=nautobot_url, token=nautobot_token, api_filter='name=test100-vm') }}"

- name: "VRF Device Assignment 1: Create VRF Device Assignment"
  networktocode.nautobot.vrf_device_assignment:
    url: "{{ nautobot_url }}"
    token: "{{ nautobot_token }}"
    vrf: "Test VRF"
    device: "test100"
    state: present
  register: test_one

- name: "VRF Device Assignment 1: ASSERT - Create VRF Device Assignment"
  assert:
    that:
      - test_one is changed
      - test_one['diff']['before']['state'] == "absent"
      - test_one['diff']['after']['state'] == "present"
      - test_one['vrf_device_assignments']['vrf'] == vrf_device_assignment_vrf['key']
      - test_one['vrf_device_assignments']['device'] == vrf_device_assignment_device['key']
      - "'created' in test_one['msg']"

- name: "VRF Device Assignment 2: Create idempotent"
  networktocode.nautobot.vrf_device_assignment:
    url: "{{ nautobot_url }}"
    token: "{{ nautobot_token }}"
    vrf: "Test VRF"
    device: "test100"
    state: present
  register: test_two

- name: "VRF Device Assignment 2: ASSERT - Create idempotent"
  assert:
    that:
      - not test_two['changed']
      - test_two['vrf_device_assignments']['vrf'] == vrf_device_assignment_vrf['key']
      - test_two['vrf_device_assignments']['device'] == vrf_device_assignment_device['key']
      - "'already exists' in test_two['msg']"

- name: "VRF Device Assignment 3: Create VRF VM Assignment"
  networktocode.nautobot.vrf_device_assignment:
    url: "{{ nautobot_url }}"
    token: "{{ nautobot_token }}"
    vrf: "Test VRF"
    virtual_machine: "test100-vm"
    state: present
  register: test_three

- name: "VRF Device Assignment 3: ASSERT - Create VRF VM Assignment"
  assert:
    that:
      - test_three is changed
      - test_three['diff']['before']['state'] == "absent"
      - test_three['diff']['after']['state'] == "present"
      - test_three['vrf_device_assignments']['vrf'] == vrf_device_assignment_vrf['key']
      - test_three['vrf_device_assignments']['virtual_machine'] == vrf_device_assignment_virtual_machine['key']
      - "'created' in test_three['msg']"

- name: "VRF Device Assignment 4: Delete VRF Device Assignment"
  networktocode.nautobot.vrf_device_assignment:
    url: "{{ nautobot_url }}"
    token: "{{ nautobot_token }}"
    vrf: "Test VRF"
    device: "test100"
    state: absent
  register: test_four

- name: "VRF Device Assignment 4: ASSERT - Delete VRF Device Assignment"
  assert:
    that:
      - test_four is changed
      - test_four['diff']['before']['state'] == "present"
      - test_four['diff']['after']['state'] == "absent"
      - "'deleted' in test_four['msg']"

- name: "VRF Device Assignment 5: Delete idempotent"
  networktocode.nautobot.vrf_device_assignment:
    url: "{{ nautobot_url }}"
    token: "{{ nautobot_token }}"
    vrf: "Test VRF"
    device: "test100"
    state: absent
  register: test_five

- name: "VRF Device Assignment 5: ASSERT - Delete idempotent"
  assert:
    that:
      - not test_five['changed']
      - "'already absent' in test_five['msg']"
